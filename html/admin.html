<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
      <button class="btn btn-outline-success" id="sign-out-button">Sign Out</button>
    <div class="container mt-3">
      <table class ="table table-dark">
        <thead>
          <th>No.</th>
          <th>Name</th>
          <th>Role</th>
          <th>User UID</th>
        </thead>
        <tbody id="tbody1"></tbody>
      </table>
    </div>
  </body>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyApxMylzZxo4C_p_OAoUuh5B5RnBrUpBCs",
      authDomain: "firedb1-4914e.firebaseapp.com",
      projectId: "firedb1-4914e",
      storageBucket: "firedb1-4914e.appspot.com",
      messagingSenderId: "274355745795",
      appId: "1:274355745795:web:7bd9613bd9dcdb8f918a36",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    import {getDatabase,ref,get,set,child,update,remove,} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const db = getDatabase();
    //ref
    

    var userNo = 0;
    var tbody = document.getElementById("tbody1")

    function addItemToTable(firstname, lastname, roleNo, uid) {
      let trow = document.createElement("tr");
      let td1 = document.createElement("td");
      let td2 = document.createElement("td")
      let td3 = document.createElement("td")
      let td4 = document.createElement("td")
      let changeRoleBtn = document.createElement("button")

      td1.innerHTML = ++userNo;
      td2.innerHTML = firstname + " " + lastname;
      td3.innerHTML = roleNo;
      td4.innerHTML = uid;
      changeRoleBtn.innerHTML = "Change Role?"
      changeRoleBtn.classList.add("change-button")

      td3.appendChild(changeRoleBtn)

      trow.appendChild(td1)
      trow.appendChild(td2)
      trow.appendChild(td3)
      trow.appendChild(td4)

      tbody.appendChild(trow)
    }

    function addItemOnce(user) {
      userNo = 0;
      tbody.innerHTML="";
      user.forEach(element => {
        addItemToTable(element.firstname, element.lastname, element.roleNo, element.uid);
      });
    }

    function getAllData(){
      const dbref = ref(db)
      get(child(dbref, "userAuthList"))
      .then((snapshot)=>{
        var users = []
        snapshot.forEach(userSnapshot => {
          users.push(userSnapshot.val());
        })
        addItemOnce(users);
      })
    }

    // Add event listener to handle role change button clicks
    tbody.addEventListener("click", function(event) {
    if (event.target.classList.contains("change-button")) {
      // Retrieve the user ID associated with the row
      let userUid = event.target.closest("tr").querySelector("td:nth-child(4)").innerHTML;
      

      // Example: Prompt user for new role
      let newRole = prompt("Enter the new role:");

      if (newRole !== null) {
        updateRole(userUid,newRole);
      }
    }
  });

  // Function to update role in the database
  function updateRole(userUid,newRole) {
    const dbref = ref(db);
      update(ref(db, "userAuthList/" + userUid),{
        roleNo: newRole
      })
      .then(() => {
        location.reload();
      })
      .catch((error) => {
        console.error("Error updating role: ", error);
      });
  }

    let signOutBtn = document.getElementById("sign-out-button");
    signOutBtn.addEventListener("click", function(){
      location.href = "./login.html";
    })

    window.onload = getAllData;
  </script>
</html>
